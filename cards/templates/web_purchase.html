{% extends 'base.html' %}
{% block title %} <title>Pitstop | Swiped Cards </title>{% endblock %}

{% block child %}
{% load filters %}
{% load render_table from django_tables2 %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/validationEngine.jquery.css" type="text/css" media="screen" title="no title"
charset="utf-8" />

<script>
function PopulateCardFlavour(){
	card_type = document.getElementById('card_type').value;
	$.ajax({
		type: "POST",
		url: "../load_flavours/",
		data: {
		card_type: card_type,
		},
	success: function(data) {
		window.location.href = window.location.href
		},
	error: function(xhr, textStatus, errorThrown) {
		alert("Please report this error: "+errorThrown+xhr.status+xhr.responseText);
		}
	});
}

function debug_test(){
    var giftCardId = $("#cardflavour_dropdown").msDropdown().value;
    alert($("#cardflavour_dropdown").msDropdown().getData());
}
function cardMake () {
    select = document.getElementById('slct1');
    select.options.length = 0;
    for(make in json) {
        select.options[select.options.length] = new Option(make, make);
    }
}
</script>
<script type="text/javascript">
function movetoNext(current, nextFieldID) {
	if (current.value.length >= current.maxLength) {
		document.getElementById(nextFieldID).focus();
	}
}
</script>
<script src="{{ STATIC_URL }}js/vendor/jquery-1.10.1.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.simpletip-1.3.1.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.validationEngine-en.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.validationEngine.js"></script>
<link rel="stylesheet" href="{{ STATIC_URL }}css/dd.css" />
<script src="{{ STATIC_URL }}js/vendor/jquery.dd.js"></script>
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/skin2.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/flags.css" />

   <div class="container contains">
        <div class="row">
            <div class="col-lg-6"><br>
                <h3>
                    Fill in and swipe cards for bulk purchase
                </h3>
            </div>
        </div>
	{% if msgs != 'Success' %}
		<div class="messages"><h4>{{ msgs }}</h4><hr></div>
	{% endif %}
		<input type="hidden" id="woolsworth" name="Language" value= "{% autoescape off %}{% for card in cardsjson %}{% if card.card_type = 'BLKHWK' %}{{card.id}}^^{{card.name}}^^{{card.small_image_file}}**{% endif %}{% endfor %}{% endautoescape %} ">
		<input type="hidden" id="cardsjson" name="Language" value= "" >
	<form class="form-inline" action="" id="formSubmit" method="POST">{% csrf_token %}
		<div class="row">
		<div class="col-lg-2"><b>Card Type {% for a in cart_flv %}
		{{ a }}
		{% endfor %}</b>
			<select class="form-control styled validate[required, custom[ctype]]" name="card_type"  id="card_type" onchange="PopulateCardFlavour(this)" value={{card.card_type}}>
				<option value="">Select Card Type</option>
				<option value="WLWRTH" {% if request.session.card_selected = 'WLWRTH' %} selected="selected" {%endif %}>Woolworths</option>
				<option value="BLKHWK" {% if request.session.card_selected = 'BLKHWK' %} selected="selected" {%endif %}>BlackHawk</option>
			</select>
		</div>
	<div class="col-lg-2">
		<b>Card Flavour</b>
		<select name="cardflavour_dropdown" class="form-control styled validate[required, custom[flavour]]" id="cardflavour_dropdown" onchange="debug_test();">
			<option value="">Select Card Flavour</option>
			{% for card in request.session.card_flv %}
			<option value= {{card.id}} data-image="{{STATIC_URL}}images/{{card.small_image_file}}" data-description="{{card.name}}" 
			{% if cflavour = card.name %}selected="selected" {% elif card_flv_name == card.name %} selected="selected" {% endif%}></option>
			{% endfor%}       
		</select>  
	</div>
	<div class="col-lg-1" >
		{{ form.amount.label_tag }} {{ form.amount }} {{card.amount}}
	</div>
	<div class="col-lg-4 " >
		{{ form.card_number.label_tag }}<br/> {{ form.card_number }} 
	</div>
	<div class="col-lg-1 addcard-alignmnt">
		<input type="submit" class="btn btn-primary" onclick="return validateControls()" value="Add card" />
	</div>	
</div>
       </form>
		<div class="row"> 
		{% if table != None %}
			<p>{% render_table table 'batches.html'%}</p>
			<script language="JavaScript">
			function toggle(source) {
				checkboxes = document.getElementsByName('selection');
				for(var i in checkboxes)
					checkboxes[i].checked = source.checked;
				}
			</script>
		{% endif %}
		</div>
</div>
	<script>
	function validateControls()
	{
		if  ($("#cardflavour_dropdown").val()=="")
		{
			$("#cardflavour_dropdown_msdd").validationEngine('validate')
			return true;
		}
		else 
		{				
			$("#cardflavour_dropdown_msdd").validationEngine('hide')
			 
			if ($("#card_type").val() != "" && $("#id_amount").val() != "" && $("#id_card_number").val() != "")
			{
      			$("#formSubmit").validationEngine('detach'); 
				return false;
			}
			else
			{
				$("#id_amount").validationEngine('validate')
				$("#id_card_number").validationEngine('validate')
				return false;
			}
		}
		
	}
$(document).ready(function(e) {	

	$("#formSubmit").validationEngine();
	$("#cardflavour_dropdown").msDropdown({roundedBorder:false});
	$("#cardflavour_dropdown_msdd").addClass('validate[required, custom[flavour]]')
	
	if ($("#card_type").val() == "")
		$("#card_type").focus()
	else if($("#cardflavour_dropdown").val() == "")
		$("#cardflavour_dropdown").focus()
	else if($("#id_amount").val() == "")
 		$("#id_amount").focus()
        else if($("#id_card_number").val() == "")
 		$("#id_card_number").focus()
        
	if ($('#cardflavour_dropdown').length > 0) {
      if  ($("#cardflavour_dropdown").hasClass('validate[required, custom[flavour]]')){
         $("#cardflavour_dropdown_msdd").addClass('validate[required, custom[flavour]]') 
		}			
    }         
});

function AttachCardFlavourValidation()
{
	if  ($("#cardflavour_dropdown").val()=="")
	{
		$("#cardflavour_dropdown_msdd").validationEngine('validate')
	}
	else 
	{
		$("#cardflavour_dropdown_msdd").validationEngine('hide')
	}
}

$('#cardflavour_dropdown').on('change', function(){ 
	AttachCardFlavourValidation();
})	

$('#cardflavour_dropdown').on('blur', function(){ 
	AttachCardFlavourValidation();
})	
   function CheckSelection()
        {
	    var n = $( "input:checked" ).length;
            if(n===0){
		alert('Please select the card(s)');
                return false;
	    }else{
		return true;
            }   
         }
</script>
{% endblock %}
